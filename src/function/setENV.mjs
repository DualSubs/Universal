/*
README: https://github.com/DualSubs
*/

import ENVs from "../ENV/ENV.mjs";
const $ = new ENVs("ğŸ¿ï¸ DualSubs: Set Environment Variables");

/**
 * Set Environment Variables
 * @author VirgilClyne
 * @param {String} name - Persistent Store Key
 * @param {Array} platforms - Platform Names
 * @param {Object} database - Default DataBase
 * @return {Object} { Settings, Caches, Configs }
 */
export default function setENV(name, platforms, database) {
	$.log(`â˜‘ï¸ ${$.name}`, "");
	let { Settings, Caches, Configs } = $.getENV(name, platforms, database);
	/***************** Settings *****************/
	if (!Array.isArray(Settings?.Types)) Settings.Types = (Settings.Types) ? [Settings.Types] : []; // åªæœ‰ä¸€ä¸ªé€‰é¡¹æ—¶ï¼Œæ— é€—å·åˆ†éš”
	if ($.isLoon() && platforms.includes("YouTube")) {
		Settings.AutoCC = $persistentStore.read("è‡ªåŠ¨æ˜¾ç¤ºç¿»è¯‘å­—å¹•") ?? Settings.AutoCC;
		switch (Settings.AutoCC) {
			case "æ˜¯":
				Settings.AutoCC = true;
				break;
			case "å¦":
				Settings.AutoCC = false;
				break;
			default:
				break;
		};
		Settings.ShowOnly = $persistentStore.read("ä»…è¾“å‡ºè¯‘æ–‡") ?? Settings.ShowOnly;
		switch (Settings.ShowOnly) {
			case "æ˜¯":
				Settings.ShowOnly = true;
				break;
			case "å¦":
				Settings.ShowOnly = false;
				break;
			default:
				break;
		};
		Settings.Position = $persistentStore.read("å­—å¹•è¯‘æ–‡ä½ç½®") ?? Settings.Position;
		switch (Settings.Position) {
			case "è¯‘æ–‡ä½äºå¤–æ–‡ä¹‹ä¸Š":
				Settings.Position = "Forward";
				break;
			case "è¯‘æ–‡ä½äºå¤–æ–‡ä¹‹ä¸‹":
				Settings.Position = "Reverse";
				break;
			default:
				break;
		};
	};
	$.log(`âœ… ${$.name}, Set Environment Variables`, `Settings: ${typeof Settings}`, `Settingså†…å®¹: ${JSON.stringify(Settings)}`, "");
	/***************** Caches *****************/
	//$.log(`âœ… ${$.name}, Set Environment Variables`, `Caches: ${typeof Caches}`, `Cacheså†…å®¹: ${JSON.stringify(Caches)}`, "");
	if (typeof Caches?.Playlists !== "object" || Array.isArray(Caches?.Playlists)) Caches.Playlists = {}; // åˆ›å»ºPlaylistsç¼“å­˜
	Caches.Playlists.Master = new Map(JSON.parse(Caches?.Playlists?.Master || "[]")); // Stringsè½¬Arrayè½¬Map
	Caches.Playlists.Subtitle = new Map(JSON.parse(Caches?.Playlists?.Subtitle || "[]")); // Stringsè½¬Arrayè½¬Map
	if (typeof Caches?.Subtitles !== "object") Caches.Subtitles = new Map(JSON.parse(Caches?.Subtitles || "[]")); // Stringsè½¬Arrayè½¬Map
	if (typeof Caches?.Metadatas !== "object" || Array.isArray(Caches?.Metadatas)) Caches.Metadatas = {}; // åˆ›å»ºPlaylistsç¼“å­˜
	if (typeof Caches?.Metadatas?.Tracks !== "object") Caches.Metadatas.Tracks = new Map(JSON.parse(Caches?.Metadatas?.Tracks || "[]")); // Stringsè½¬Arrayè½¬Map
	/***************** Configs *****************/
	return { Settings, Caches, Configs };
};
